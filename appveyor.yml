version: 1.0.1-{build}

environment:
  # zfpy only build for Release builds (otherwise need debug python libs python27_d.lib)
  matrix:
    - COMPILER: msvc
      GENERATOR: Visual Studio 15 2017 Win64
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2022
      PLATFORM: x64
      BUILD_TYPE: Release
      PYTHON_VERSION: 39

    - COMPILER: msvc
      GENERATOR: Visual Studio 15 2017
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2022
      PLATFORM: Win32
      BUILD_TYPE: Release
      PYTHON_VERSION: 39

    - COMPILER: msvc
      GENERATOR: Visual Studio 14 2019 Win64
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
      PLATFORM: x64
      BUILD_TYPE: Release
      PYTHON_VERSION: 39

    - COMPILER: msvc
      GENERATOR: Visual Studio 14 2019
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
      PLATFORM: Win32
      BUILD_TYPE: Release
      PYTHON_VERSION: 39

    - COMPILER: mingw
      GENERATOR: MinGW Makefiles
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      PLATFORM: Win32
      BUILD_TYPE: Release
      PYTHON_VERSION: 39

    - COMPILER: mingw-w64
      GENERATOR: MinGW Makefiles
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2022
      PLATFORM: x64
      BUILD_TYPE: Release
      PYTHON_VERSION: 39

install:
  - if "%COMPILER%"=="mingw" set PATH=C:\MinGW\bin;%PATH%
  - if "%COMPILER%"=="mingw-w64" set PATH=C:\MinGW\bin;%PATH%

  # set env vars for Python system dir (assumed to always be MSVC)
  - if not "%PYTHON_VERSION%" == "" (
      set "PYTHON_DIR=C:\Python%PYTHON_VERSION%"
      if "%PLATFORM%" == "x64" (
        set "PYTHON_DIR=%PYTHON_DIR%-x64"
      )
      set "PYTHON_LIB_PATH=%PYTHON_DIR%\libs\python%PYTHON_VERSION%.lib"
    )
  - if not "%PYTHON_DIR%" == "" if not exists "%PYTHON_DIR%" exit 1
  # placing these behind a conditional for some reason prevents CMake from picking up the virtualenv
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" set "PATH=%PYTHON_DIR%;%PYTHON_DIR%\Scripts;%PATH%"
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" pip3 install virtualenv
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" set VIRTUALENV_NAME=pyVirtualEnv
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" virtualenv %VIRTUALENV_NAME%
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" "%VIRTUALENV_NAME%\\Scripts\\activate.bat"
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" pip3 install -r python\requirements.txt
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" python --version


build_script:
  - sh appveyor.sh
  # uncomment to enable interactive remote desktop mode
  # - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
