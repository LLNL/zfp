version: 1.0.1-{build}

environment:
  # zfpy only build for Release builds (otherwise need debug python libs python27_d.lib)
  matrix:
    - COMPILER: msvc
      GENERATOR: Visual Studio 17 2022 Win64
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2022
      PLATFORM: x64
      BUILD_TYPE: Release
      PYTHON_VERSION: 39

    - COMPILER: msvc
      GENERATOR: Visual Studio 17 2022
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2022
      PLATFORM: Win32
      BUILD_TYPE: Release
      PYTHON_VERSION: 39

    - COMPILER: msvc
      GENERATOR: Visual Studio 16 2019 Win64
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
      PLATFORM: x64
      BUILD_TYPE: Release
      PYTHON_VERSION: 39

    - COMPILER: msvc
      GENERATOR: Visual Studio 16 2019
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
      PLATFORM: Win32
      BUILD_TYPE: Release
      PYTHON_VERSION: 39

    - COMPILER: mingw
      GENERATOR: MinGW Makefiles
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
      PLATFORM: Win32
      BUILD_TYPE: Release
      PYTHON_VERSION: 39

    - COMPILER: mingw-w64
      GENERATOR: MinGW Makefiles
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2022
      PLATFORM: x64
      BUILD_TYPE: Release
      PYTHON_VERSION: 39

install:
  - if "%COMPILER%"=="mingw" set PATH=C:\MinGW\bin;%PATH%
  - if "%COMPILER%"=="mingw-w64" set PATH=C:\MinGW\bin;%PATH%

  # set env vars for Python system dir (assumed to always be MSVC)
  - ps: |
      if ($env:PYTHON_VERSION) {
        $env:PYTHON_DIR = "C:\Python$env:PYTHON_VERSION"
        if ($env:PLATFORM -eq "x64") {
          $env:PYTHON_DIR = "$env:PYTHON_DIR-x64"
        }

        $env:PYTHON_LIB_PATH = "$env:PYTHON_DIR\libs\python$env:PYTHON_VERSION.lib"
      }

  - if not "%PYTHON_DIR%" == "" if not exist "%PYTHON_DIR%" exit 1
  # placing these behind a conditional for some reason prevents CMake from picking up the virtualenv
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" set "PATH=%PYTHON_DIR%;%PYTHON_DIR%\Scripts;%PATH%"
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" pip3 install virtualenv
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" set VIRTUALENV_NAME=pyVirtualEnv
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" virtualenv %VIRTUALENV_NAME%
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" "%VIRTUALENV_NAME%\\Scripts\\activate.bat"
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" pip3 install -r python\requirements.txt
  - if "%COMPILER%"=="msvc" if "%BUILD_TYPE%"=="Release" python --version


build_script:
  - sh appveyor.sh
  # uncomment to enable interactive remote desktop mode
  # - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
